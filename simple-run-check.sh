#!/usr/bin/env bash
set -euET -o pipefail

script_name=$(basename $0)
script_dir=$(dirname $0)

cat<<EOF
================================================================================
check that the server is not running
================================================================================
EOF
make stop

make | grep nextjs- |
    grep Switch |
    awk '{print $2}' |
#    grep -v nextjs-16.0.6 |
    while read version ; do
    cat<<EOF
================================================================================
version=[${version}]: switch
================================================================================
EOF
    make ${version}

    cat<<EOF
================================================================================
version=[${version}]: start
================================================================================
EOF
    make start

    cat<<EOF
================================================================================
version=[${version}]: curl
================================================================================
EOF
    curl -s http://localhost:3000/api/version | jq

    cat<<EOF
================================================================================
version=[${version}]: stop
================================================================================
EOF
    make stop
done
