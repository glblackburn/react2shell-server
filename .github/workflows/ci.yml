name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '24.12.0'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Lint and Validate
  # Purpose: Quick validation before running expensive tests
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check Makefile syntax
        run: |
          make -n help > /dev/null 2>&1 || (echo "ERROR: Makefile syntax check failed" && exit 1)
          echo "✅ Makefile syntax is valid"
      
      - name: Validate YAML files
        run: |
          echo "Validating YAML files..."
          # Install PyYAML if needed (usually pre-installed in ubuntu-latest)
          python3 -c "import yaml" 2>/dev/null || pip3 install --user pyyaml || echo "PyYAML check skipped"
          
          # Check workflow files
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>&1 || (echo "ERROR: Invalid YAML in $file" && exit 1)
              echo "✅ $file is valid YAML"
            fi
          done
      
      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          # Check for package.json files (skip node_modules)
          find . -name "package.json" -type f -not -path "*/node_modules/*" | while read -r file; do
            python3 -c "import json; json.load(open('$file'))" 2>&1 || (echo "ERROR: Invalid JSON in $file" && exit 1)
            echo "✅ $file is valid JSON"
          done || echo "No package.json files found (this is OK)"
      
      - name: Basic file validation
        run: |
          echo "Performing basic file validation..."
          # Check that required files exist
          [ -f "Makefile" ] || (echo "ERROR: Makefile not found" && exit 1)
          [ -f "README.md" ] || (echo "ERROR: README.md not found" && exit 1)
          [ -d ".github/workflows" ] || (echo "ERROR: .github/workflows directory not found" && exit 1)
          echo "✅ Required files and directories exist"
          
          # Check for common issues
          if find . -name "*.md" -type f -exec grep -l "  $" {} \; | grep -v node_modules | head -1; then
            echo "WARNING: Found files with trailing whitespace (non-blocking)"
          fi
          echo "✅ Basic file validation complete"
      
      - name: Lint job summary
        run: |
          echo "✅ All lint checks passed"
          echo "Lint job completed successfully"

  # Job 2: Test Vite + React Framework
  # Purpose: Test Vite framework with React versions
  # TODO: Implement in Step 3
  test-vite:
    name: Test Vite Framework
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Vite test job to be implemented
        run: echo "Vite test job - implementation pending"

  # Job 3: Test Next.js Framework
  # Purpose: Test Next.js framework with Next.js versions
  # TODO: Implement in Step 4
  test-nextjs:
    name: Test Next.js Framework
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Next.js test job to be implemented
        run: echo "Next.js test job - implementation pending"

  # Job 4: Python Tests (Matrix)
  # Purpose: Run comprehensive Python test suite
  # TODO: Implement in Step 5
  test-python:
    name: Test Python (${{ matrix.framework }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        framework: [vite, nextjs]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Python test job to be implemented
        run: echo "Python test job for ${{ matrix.framework }} - implementation pending"

  # Job 5: Version Validation
  # Purpose: Validate version switching works
  # TODO: Implement in Step 6
  validate-versions:
    name: Validate Versions
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Version validation job to be implemented
        run: echo "Version validation job - implementation pending"
