name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '24.12.0'
  PYTHON_VERSION: '3.11'

jobs:
  # Job 1: Lint and Validate
  # Purpose: Quick validation before running expensive tests
  # TODO: Implement in Step 2
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Lint job to be implemented
        run: echo "Lint job - implementation pending"

  # Job 2: Test Vite + React Framework
  # Purpose: Test Vite framework with React versions
  test-vite:
    name: Test Vite Framework
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install nvm
        run: |
          curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm install ${{ env.NODE_VERSION }}
          nvm use ${{ env.NODE_VERSION }}
          echo "NVM_DIR=$NVM_DIR" >> $GITHUB_ENV
      
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      
      - name: Setup project
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make setup
      
      - name: Switch to Vite framework
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make use-vite
      
      - name: Test with vulnerable React version (19.0)
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make react-19.0
          echo "✅ Switched to React 19.0"
      
      - name: Start servers
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make start
          echo "✅ Servers started"
      
      - name: Wait for servers to be ready
        run: |
          echo "Waiting for servers to be ready..."
          sleep 10
          # Check if servers are running
          if lsof -ti:5173 >/dev/null 2>&1 && lsof -ti:3000 >/dev/null 2>&1; then
            echo "✅ Both servers are running"
          else
            echo "⚠️  Servers may not be fully ready, continuing..."
          fi
      
      - name: Setup Python test environment
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make test-setup
      
      - name: Run smoke tests
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make test-nextjs-startup
      
      - name: Stop servers
        if: always()
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make stop || true
          echo "✅ Servers stopped"
      
      - name: Test with fixed React version (19.2.1)
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make react-19.2.1
          echo "✅ Switched to React 19.2.1"
      
      - name: Start servers (fixed version)
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make start
          echo "✅ Servers started with fixed version"
      
      - name: Wait for servers to be ready (fixed version)
        run: |
          echo "Waiting for servers to be ready..."
          sleep 10
          if lsof -ti:5173 >/dev/null 2>&1 && lsof -ti:3000 >/dev/null 2>&1; then
            echo "✅ Both servers are running"
          else
            echo "⚠️  Servers may not be fully ready, continuing..."
          fi
      
      - name: Run smoke tests (fixed version)
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make test-nextjs-startup
      
      - name: Cleanup
        if: always()
        run: |
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          make stop || true
          echo "✅ Cleanup complete"

  # Job 3: Test Next.js Framework
  # Purpose: Test Next.js framework with Next.js versions
  # TODO: Implement in Step 4
  test-nextjs:
    name: Test Next.js Framework
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Next.js test job to be implemented
        run: echo "Next.js test job - implementation pending"

  # Job 4: Python Tests (Matrix)
  # Purpose: Run comprehensive Python test suite
  # TODO: Implement in Step 5
  test-python:
    name: Test Python (${{ matrix.framework }})
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        framework: [vite, nextjs]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Python test job to be implemented
        run: echo "Python test job for ${{ matrix.framework }} - implementation pending"

  # Job 5: Version Validation
  # Purpose: Validate version switching works
  # TODO: Implement in Step 6
  validate-versions:
    name: Validate Versions
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder - Version validation job to be implemented
        run: echo "Version validation job - implementation pending"
